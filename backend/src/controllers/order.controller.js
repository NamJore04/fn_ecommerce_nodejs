const Order = require('../models/Order');
const Cart = require('../models/Cart');
const User = require('../models/User');
const asyncHandler = require('../middleware/async');
const AppError = require('../middleware/errorResponse');

// @desc    Create new order
// @route   POST /api/orders
// @access  Public
const createOrder = asyncHandler(async (req, res) => {
  const { 
    shippingAddress, 
    paymentMethod, 
    discountCode, 
    loyaltyPointsUsed, 
    guestInfo,
    items,
    subtotal,
    tax,
    shipping,
    discount,
    total,
    vnpayTransactionNo
  } = req.body;

  // Check for duplicate VNPay order (prevent double submission)
  if (vnpayTransactionNo) {
    const existingOrder = await Order.findOne({ vnpayTransactionNo });
    if (existingOrder) {
      console.log('âš ï¸ Duplicate VNPay order detected:', vnpayTransactionNo);
      return res.status(200).json({
        success: true,
        message: 'Order already exists',
        data: { order: existingOrder }
      });
    }
  }

  let user = req.user;
  let cart;
  let isNewGuestAccount = false;
  let generatedPassword = '';

  // Handle guest checkout
  if (!user && guestInfo) {
    // Check if user with this email already exists
    let existingUser = await User.findOne({ email: guestInfo.email });
    
    if (!existingUser) {
      // Parse shipping address for saving to user profile
      const addressParts = typeof shippingAddress === 'string' 
        ? shippingAddress.split(',').map(s => s.trim()) 
        : [];
      
      // Create default address from shipping info
      const defaultAddress = {
        type: 'default',
        fullName: guestInfo.fullName,
        street: typeof shippingAddress === 'string' ? shippingAddress : (shippingAddress?.street || 'N/A'),
        city: addressParts[addressParts.length - 2] || shippingAddress?.city || 'Ho Chi Minh City',
        state: addressParts[addressParts.length - 1] || shippingAddress?.state || 'Ho Chi Minh',
        zipCode: shippingAddress?.zipCode || '700000',
        country: shippingAddress?.country || 'Vietnam',
        phone: guestInfo.phone || '',
        isDefault: true
      };

      // Create new user account automatically with shipping address
      generatedPassword = Math.random().toString(36).slice(-8);
      existingUser = await User.create({
        email: guestInfo.email,
        fullName: guestInfo.fullName,
        phone: guestInfo.phone,
        password: generatedPassword,
        role: 'customer',
        isEmailVerified: false,
        addresses: [defaultAddress]
      });
      isNewGuestAccount = true;
      console.log('ğŸ“ New guest account created with default address:', existingUser.email);
    }
    
    user = existingUser;
  }

  // Get cart (for authenticated users) or use items from request body (for guests)
  if (req.user) {
    cart = await Cart.findByUser(req.user.id);
    if (!cart || cart.isEmpty()) {
      return res.status(400).json({
        success: false,
        message: 'Cart is empty'
      });
    }
    // Populate cart items with product details
    await cart.populate({
      path: 'items.product',
      select: 'name images brand category basePrice variants totalStock'
    });
  }

  // Prepare order data (orderNumber will be generated by pre-save middleware)
  const orderData = {
    status: 'pending', // Set default status
    paymentMethod,
    subtotal: cart ? cart.subtotal : subtotal,
    tax: cart ? cart.tax : tax,
    shipping: cart ? cart.shipping : shipping,
    discount: cart ? cart.discount : discount,
    total: cart ? cart.total : total,
    discountCode: cart ? cart.discountCode : discountCode,
    loyaltyPointsUsed: cart ? cart.loyaltyPointsUsed : loyaltyPointsUsed,
    vnpayTransactionNo: vnpayTransactionNo || null
  };

  // Add user or guest info
  if (user) {
    orderData.user = user._id;
  } else if (guestInfo) {
    orderData.guestInfo = guestInfo;
  }

  // Parse shipping address - Frontend sends string, convert to required object
  const addressParts = typeof shippingAddress === 'string' 
    ? shippingAddress.split(',').map(s => s.trim()) 
    : [];
  
  orderData.shippingAddress = {
    fullName: guestInfo?.fullName || user?.fullName || 'Customer',
    street: typeof shippingAddress === 'string' ? shippingAddress : (shippingAddress?.street || 'N/A'),
    city: addressParts[addressParts.length - 2] || shippingAddress?.city || 'Ho Chi Minh City',
    state: addressParts[addressParts.length - 1] || shippingAddress?.state || 'Ho Chi Minh',
    zipCode: shippingAddress?.zipCode || '700000',
    country: shippingAddress?.country || 'Vietnam',
    email: guestInfo?.email || user?.email || '',
    phone: guestInfo?.phone || user?.phone || ''
  };

  // Add items - Map cart items to order items with required fields
  if (cart && cart.items && cart.items.length > 0) {
    orderData.items = cart.items.map(item => {
      const product = item.product;
      const variant = item.variant;
      
      // Find variant data from product.variants if variant ID exists
      let variantData = null;
      if (variant && product.variants && product.variants.length > 0) {
        variantData = product.variants.find(v => 
          v._id && variant._id && v._id.toString() === variant._id.toString()
        );
      }
      
      return {
        product: product._id || product,
        variant: variant?._id || null,
        productName: product.name || 'Product',
        variantName: variantData?.name || variant?.name || 'Standard',
        quantity: item.quantity || 1,
        price: variantData?.price || variant?.price || product.basePrice || 0,
        total: (variantData?.price || variant?.price || product.basePrice || 0) * (item.quantity || 1),
        image: product.images && product.images.length > 0 
          ? (typeof product.images[0] === 'string' ? product.images[0] : product.images[0].url || product.images[0])
          : null
      };
    });
  } else if (items && items.length > 0) {
    orderData.items = items.map(item => {
      const productImages = item.product?.images;
      let imageUrl = null;
      if (productImages && productImages.length > 0) {
        imageUrl = typeof productImages[0] === 'string' ? productImages[0] : productImages[0].url || productImages[0];
      } else if (item.image) {
        imageUrl = typeof item.image === 'string' ? item.image : item.image.url || item.image;
      }
      
      return {
        product: item.product?._id || item.product,
        variant: item.variant?._id || null,
        productName: item.product?.name || item.productName || 'Product',
        variantName: item.variant?.name || item.variantName || 'Standard',
        quantity: item.quantity || 1,
        price: item.variant?.price || item.product?.basePrice || item.price || 0,
        total: (item.variant?.price || item.product?.basePrice || item.price || 0) * (item.quantity || 1),
        image: imageUrl
      };
    });
  } else {
    return res.status(400).json({
      success: false,
      message: 'No items to order'
    });
  }

  // Debug log
  console.log('ğŸ“¦ Creating order with data:', JSON.stringify({
    orderNumber: orderData.orderNumber,
    user: orderData.user,
    guestInfo: orderData.guestInfo,
    shippingAddress: orderData.shippingAddress,
    items: orderData.items.length,
    itemsSample: orderData.items[0]
  }, null, 2));

  // Create order
  console.log('ğŸ“¦ Order data before creation:', JSON.stringify({
    orderNumber: orderData.orderNumber,
    status: orderData.status || 'pending',
    user: orderData.user,
    guestInfo: orderData.guestInfo,
    itemsCount: orderData.items?.length || 0
  }, null, 2));
  
  const order = await Order.create(orderData);
  
  console.log('ğŸ“¦ Order created successfully:', {
    id: order._id,
    orderNumber: order.orderNumber,
    status: order.status
  });

  // Deduct stock from product variants
  const Product = require('../models/Product');
  for (const item of order.items) {
    try {
      const product = await Product.findById(item.product);
      if (product) {
        const variantIndex = product.variants.findIndex(v => 
          v._id && item.variant && v._id.toString() === item.variant.toString()
        );
        
        if (variantIndex !== -1) {
          // Deduct stock from specific variant
          const newStock = Math.max(0, product.variants[variantIndex].stock - item.quantity);
          product.variants[variantIndex].stock = newStock;
          console.log(`ğŸ“¦ Stock deducted: ${product.name} - ${product.variants[variantIndex].name}: ${item.quantity} units (New stock: ${newStock})`);
        } else if (product.variants.length > 0) {
          // If variant not found, deduct from first variant
          const newStock = Math.max(0, product.variants[0].stock - item.quantity);
          product.variants[0].stock = newStock;
          console.log(`ğŸ“¦ Stock deducted (default variant): ${product.name}: ${item.quantity} units (New stock: ${newStock})`);
        }
        
        // Recalculate totalStock
        product.totalStock = product.variants.reduce((sum, v) => sum + (v.stock || 0), 0);
        await product.save();
      }
    } catch (stockError) {
      console.error(`âŒ Failed to deduct stock for product ${item.product}:`, stockError.message);
      // Continue with order creation even if stock deduction fails
    }
  }
  console.log('ğŸ“¦ Stock deduction completed for order:', order.orderNumber);

  // Calculate loyalty points earned (10% of total)
  if (order.calculateLoyaltyPoints) {
    await order.calculateLoyaltyPoints();
    console.log('ğŸ Loyalty points calculated:', {
      orderTotal: order.total,
      loyaltyPointsEarned: order.loyaltyPointsEarned
    });
  }

  // Add loyalty points to user (if authenticated)
  if (user && user.addLoyaltyPoints && order.loyaltyPointsEarned) {
    console.log('ğŸ Adding loyalty points to user:', {
      userId: user._id,
      pointsToAdd: order.loyaltyPointsEarned,
      currentPoints: user.loyaltyPoints
    });
    await user.addLoyaltyPoints(order.loyaltyPointsEarned);
    console.log('ğŸ Loyalty points added successfully');
  }

  // Mark discount code as used (if applicable)
  if (orderData.discountCode && orderData.discount > 0) {
    const DiscountCode = require('../models/DiscountCode');
    const discount = await DiscountCode.findByCode(orderData.discountCode);
    if (discount) {
      try {
        await discount.useCode(user?._id, order._id, orderData.discount);
      } catch (error) {
        console.error('Failed to mark discount code as used:', error.message);
      }
    }
  }

  // Deduct loyalty points from user (if used)
  if (user && orderData.loyaltyPointsUsed > 0) {
    try {
      // Convert VND back to points: loyaltyPointsUsed is in VND, need to convert to points
      const pointsUsed = Math.floor(orderData.loyaltyPointsUsed / 1000);
      console.log('ğŸ Deducting loyalty points from user:', {
        userId: user._id,
        loyaltyPointsUsedVND: orderData.loyaltyPointsUsed,
        pointsUsed: pointsUsed,
        currentPoints: user.loyaltyPoints
      });
      await user.useLoyaltyPoints(pointsUsed);
      console.log('ğŸ Loyalty points deducted successfully');
    } catch (error) {
      console.error('Failed to deduct loyalty points:', error.message);
    }
  }

  // Clear cart (if authenticated)
  if (cart) {
    await cart.clearCart();
  }

  // Also clear guest cart by sessionId (for guest checkout)
  const sessionId = req.headers['x-session-id'] || req.sessionID;
  if (sessionId && !req.user) {
    try {
      const guestCart = await Cart.findOne({ sessionId });
      if (guestCart) {
        await guestCart.clearCart();
        console.log('ğŸ›’ Guest cart cleared for session:', sessionId);
      }
    } catch (err) {
      console.error('âŒ Failed to clear guest cart:', err.message);
    }
  }

  // Send order confirmation email via queue (async processing)
  try {
    const { addEmailJob } = require('../services/queue/emailQueue');
    
    // Prepare user data for email
    const emailUser = user || {
      email: guestInfo.email,
      fullName: guestInfo.fullName
    };
    
    // Add email job to queue (non-blocking)
    await addEmailJob('order-confirmation', {
      order: {
        _id: order._id,
        orderNumber: order.orderNumber,
        createdAt: order.createdAt,
        total: order.total,
        status: order.status,
        items: order.items.map(item => ({
          productName: item.productName,
          variantName: item.variantName,
          quantity: item.quantity,
          price: item.price,
          total: item.total
        })),
        shippingAddress: order.shippingAddress,
        paymentMethod: order.paymentMethod
      },
      user: emailUser
    }, {
      priority: 2, // High priority for order confirmations
      attempts: 3
    });
    
    console.log(`ğŸ“¨ Order confirmation email queued for: ${emailUser.email}`);
  } catch (error) {
    // Log error but don't fail the order creation
    console.error('âŒ Failed to queue order confirmation email:', error.message);
    console.log('âš ï¸ Order created successfully but email notification failed');
    
    // Try direct email send as fallback
    try {
      const { sendEmail } = require('../services/emailService');
      const customerEmail = user ? user.email : guestInfo.email;
      const customerName = user ? user.fullName : guestInfo.fullName;
      
      const htmlContent = `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
          <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px 10px 0 0;">
            <h1 style="color: white; margin: 0;">ğŸ›’ XÃ¡c Nháº­n ÄÆ¡n HÃ ng</h1>
          </div>
          <div style="padding: 30px; background: #f9f9f9; border-radius: 0 0 10px 10px;">
            <h2 style="color: #333;">Cáº£m Æ¡n báº¡n, ${customerName}! ğŸ‰</h2>
            <p style="color: #666; line-height: 1.6;">ÄÆ¡n hÃ ng cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c Ä‘áº·t thÃ nh cÃ´ng.</p>
            
            <div style="background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 20px; margin: 20px 0;">
              <h3 style="color: #333; margin-top: 0;">ğŸ“¦ Chi Tiáº¿t ÄÆ¡n HÃ ng</h3>
              <p style="color: #666; margin: 5px 0;"><strong>MÃ£ Ä‘Æ¡n hÃ ng:</strong> ${order.orderNumber}</p>
              <p style="color: #666; margin: 5px 0;"><strong>NgÃ y Ä‘áº·t:</strong> ${new Date(order.createdAt).toLocaleDateString('vi-VN')}</p>
              <p style="color: #666; margin: 5px 0;"><strong>Tráº¡ng thÃ¡i:</strong> ${order.status}</p>
              <p style="color: #28a745; margin: 5px 0; font-size: 18px;"><strong>Tá»•ng tiá»n:</strong> ${order.total.toLocaleString('vi-VN')} VND</p>
            </div>
            
            <div style="background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 20px; margin: 20px 0;">
              <h3 style="color: #333; margin-top: 0;">ğŸ›ï¸ Sáº£n Pháº©m ÄÃ£ Äáº·t</h3>
              ${order.items.map(item => `
                <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;">
                  <span style="color: #666;">${item.productName} (${item.variantName}) x${item.quantity}</span>
                  <span style="color: #333; font-weight: bold;">${item.total.toLocaleString('vi-VN')} VND</span>
                </div>
              `).join('')}
            </div>
            
            <p style="color: #666; line-height: 1.6;">ChÃºng tÃ´i sáº½ xá»­ lÃ½ Ä‘Æ¡n hÃ ng vÃ  gá»­i thÃ´ng bÃ¡o cáº­p nháº­t qua email.</p>
            
            <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0;">
            <p style="color: #999; font-size: 12px; text-align: center;">Cáº£m Æ¡n báº¡n Ä‘Ã£ mua sáº¯m táº¡i TechStore!</p>
            <p style="color: #999; font-size: 12px; text-align: center;">Â© 2025 TechStore. All rights reserved.</p>
          </div>
        </div>
      `;
      
      await sendEmail({
        email: customerEmail,
        subject: `XÃ¡c Nháº­n ÄÆ¡n HÃ ng - ${order.orderNumber}`,
        html: htmlContent,
        message: `ÄÆ¡n hÃ ng ${order.orderNumber} Ä‘Ã£ Ä‘Æ°á»£c Ä‘áº·t thÃ nh cÃ´ng. Tá»•ng tiá»n: ${order.total.toLocaleString('vi-VN')} VND`
      });
      
      console.log('ğŸ“§ Order confirmation email sent directly (fallback):', customerEmail);
    } catch (fallbackError) {
      console.error('âŒ Fallback email also failed:', fallbackError.message);
      // Continue - order is still created successfully
    }
  }

  // Send welcome email for new guest accounts
  if (isNewGuestAccount && generatedPassword) {
    try {
      const { sendEmail } = require('../services/emailService');
      
      const clientUrl = process.env.CLIENT_URL || 'http://localhost:3000';
      const htmlContent = `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
          <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-radius: 10px 10px 0 0;">
            <h1 style="color: white; margin: 0;">ğŸ‰ ChÃ o Má»«ng Äáº¿n TechStore!</h1>
          </div>
          <div style="padding: 30px; background: #f9f9f9; border-radius: 0 0 10px 10px;">
            <h2 style="color: #333;">Xin chÃ o ${user.fullName}!</h2>
            <p style="color: #666; line-height: 1.6;">Má»™t tÃ i khoáº£n Ä‘Ã£ Ä‘Æ°á»£c tá»± Ä‘á»™ng táº¡o cho báº¡n dá»±a trÃªn Ä‘Æ¡n hÃ ng gáº§n Ä‘Ã¢y.</p>
            
            <div style="background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 20px; margin: 20px 0;">
              <h3 style="color: #333; margin-top: 0;">ğŸ“‹ ThÃ´ng Tin TÃ i Khoáº£n</h3>
              <p style="color: #666; margin: 5px 0;"><strong>Email:</strong> ${user.email}</p>
              <p style="color: #666; margin: 5px 0;"><strong>Máº­t kháº©u táº¡m thá»i:</strong> <code style="background: #f0f0f0; padding: 2px 8px; border-radius: 4px; font-size: 16px;">${generatedPassword}</code></p>
            </div>
            
            <p style="color: #dc3545; font-weight: bold;">âš ï¸ Vui lÃ²ng Ä‘Äƒng nháº­p vÃ  Ä‘á»•i máº­t kháº©u Ä‘á»ƒ báº£o máº­t tÃ i khoáº£n!</p>
            
            <div style="text-align: center; margin: 30px 0;">
              <a href="${clientUrl}/login" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 25px; font-weight: bold; display: inline-block;">ÄÄƒng Nháº­p Ngay</a>
            </div>
            
            <div style="background: #e7f5ff; border-left: 4px solid #007bff; padding: 15px; border-radius: 4px; margin: 20px 0;">
              <p style="color: #007bff; margin: 0;">âœ… ÄÆ¡n hÃ ng <strong>#${order.orderNumber}</strong> Ä‘Ã£ Ä‘Æ°á»£c Ä‘áº·t thÃ nh cÃ´ng!</p>
            </div>
            
            <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0;">
            <p style="color: #999; font-size: 12px; text-align: center;">Cáº£m Æ¡n báº¡n Ä‘Ã£ mua sáº¯m táº¡i TechStore!</p>
            <p style="color: #999; font-size: 12px; text-align: center;">Â© 2025 TechStore. All rights reserved.</p>
          </div>
        </div>
      `;
      
      await sendEmail({
        email: user.email,
        subject: 'ChÃ o Má»«ng Äáº¿n TechStore - TÃ i Khoáº£n ÄÃ£ ÄÆ°á»£c Táº¡o',
        html: htmlContent,
        message: `ChÃ o má»«ng ${user.fullName}! TÃ i khoáº£n: ${user.email}, Máº­t kháº©u: ${generatedPassword}. ÄÄƒng nháº­p: ${clientUrl}/login`
      });
      
      console.log('ğŸ“§ Welcome email sent to new guest account:', user.email);
    } catch (welcomeError) {
      console.error('âŒ Failed to send welcome email:', welcomeError.message);
      // Continue - order is still created successfully
    }
  }

  res.status(201).json({
    success: true,
    message: 'Order created successfully',
    data: { order }
  });
});

// @desc    Get user orders
// @route   GET /api/orders/my
// @access  Private
const getMyOrders = asyncHandler(async (req, res) => {
  const { status, page = 1, limit = 10 } = req.query;
  
  const pageNum = parseInt(page);
  const limitNum = parseInt(limit);
  
  const filter = { user: req.user.id };
  if (status) filter.status = status;
  
  const orders = await Order.find(filter)
    .sort({ createdAt: -1 })
    .limit(limitNum)
    .skip((pageNum - 1) * limitNum)
    .populate('items.product', 'name images');
  
  const total = await Order.countDocuments(filter);
  const totalPages = Math.ceil(total / limitNum);
  const hasNextPage = pageNum < totalPages;
  const hasPrevPage = pageNum > 1;
  
  // Debug logging
  console.log('ğŸ“¦ User orders debug:', {
    userId: req.user.id,
    filter,
    ordersCount: orders.length,
    orders: orders.map(order => ({
      id: order._id,
      orderNumber: order.orderNumber,
      status: order.status,
      hasOrderNumber: !!order.orderNumber,
      hasStatus: !!order.status
    }))
  });
  
  res.json({
    success: true,
    count: orders.length,
    total,
    pagination: {
      currentPage: pageNum,
      totalPages,
      hasNextPage,
      hasPrevPage,
      nextPage: hasNextPage ? pageNum + 1 : null,
      prevPage: hasPrevPage ? pageNum - 1 : null
    },
    data: orders
  });
});

// @desc    Get all orders (Admin)
// @route   GET /api/orders
// @access  Private/Admin
const getOrders = asyncHandler(async (req, res) => {
  const { status, page = 1, limit = 10 } = req.query;
  
  const pageNum = parseInt(page);
  const limitNum = parseInt(limit);
  
  const filter = {};
  if (status) {
    filter.status = status;
  }
  
  const orders = await Order.find(filter)
    .populate('user', 'fullName email')
    .sort({ createdAt: -1 })
    .limit(limitNum)
    .skip((pageNum - 1) * limitNum);
  
  const total = await Order.countDocuments(filter);
  const totalPages = Math.ceil(total / limitNum);
  const hasNextPage = pageNum < totalPages;
  const hasPrevPage = pageNum > 1;
  
  res.json({
    success: true,
    count: orders.length,
    total,
    pagination: {
      currentPage: pageNum,
      totalPages,
      hasNextPage,
      hasPrevPage,
      nextPage: hasNextPage ? pageNum + 1 : null,
      prevPage: hasPrevPage ? pageNum - 1 : null
    },
    data: orders
  });
});

// @desc    Get single order
// @route   GET /api/orders/:id
// @access  Private
const getOrder = asyncHandler(async (req, res) => {
  console.log('ğŸ“¦ Getting order with ID:', req.params.id);
  
  const order = await Order.findById(req.params.id)
    .populate('items.product', 'name images')
    .populate('user', 'fullName email');

  console.log('ğŸ“¦ Found order:', {
    found: !!order,
    orderId: order?._id,
    orderNumber: order?.orderNumber,
    status: order?.status
  });

  if (!order) {
    console.log('âŒ Order not found');
    return res.status(404).json({
      success: false,
      message: 'Order not found'
    });
  }

  // Debug logging
  console.log('ğŸ“¦ Order debug:', {
    orderId: order._id,
    orderNumber: order.orderNumber,
    status: order.status,
    hasOrderNumber: !!order.orderNumber,
    hasStatus: !!order.status,
    user: order.user?._id,
    guestInfo: order.guestInfo
  });

  // Check if user owns this order or is admin
  console.log('ğŸ“¦ Authorization check:', {
    orderUserId: order.user?._id?.toString(),
    requestUserId: req.user.id,
    userRole: req.user.role,
    hasOrderUser: !!order.user,
    isOwner: order.user && order.user._id.toString() === req.user.id,
    isAdmin: req.user.role === 'admin'
  });
  
  if (order.user && order.user._id.toString() !== req.user.id && req.user.role !== 'admin') {
    console.log('âŒ Authorization failed');
    return res.status(403).json({
      success: false,
      message: 'Not authorized to view this order'
    });
  }

  console.log('ğŸ“¦ Sending order response:', {
    orderId: order._id,
    orderNumber: order.orderNumber,
    status: order.status,
    hasOrderNumber: !!order.orderNumber,
    hasStatus: !!order.status
  });

  res.json({
    success: true,
    data: { order }
  });
});

// @desc    Update order status
// @route   PUT /api/orders/:id/status
// @access  Private
const updateOrderStatus = asyncHandler(async (req, res) => {
  const { status, note } = req.body;
  
  console.log('ğŸ“¦ Update order status request:', {
    orderId: req.params.id,
    status,
    userId: req.user.id,
    userRole: req.user.role
  });
  
  const order = await Order.findById(req.params.id);
  if (!order) {
    return res.status(404).json({
      success: false,
      message: 'Order not found'
    });
  }
  
  console.log('ğŸ“¦ Found order:', {
    orderId: order._id,
    orderUserId: order.user,
    orderStatus: order.status,
    canBeCancelled: order.canBeCancelled ? order.canBeCancelled() : 'method not found'
  });

  // Check authorization
  const orderUserId = order.user ? order.user.toString() : order.user;
  console.log('ğŸ” Authorization check:', {
    orderUserId,
    requestUserId: req.user.id,
    userRole: req.user.role,
    isAdmin: req.user.role === 'admin',
    isOwner: orderUserId === req.user.id,
    canUpdate: orderUserId === req.user.id || req.user.role === 'admin'
  });
  
  if (orderUserId && orderUserId !== req.user.id && req.user.role !== 'admin') {
    console.log('âŒ Authorization failed:', {
      orderUserId,
      requestUserId: req.user.id,
      userRole: req.user.role,
      isAdmin: req.user.role === 'admin'
    });
    return res.status(403).json({
      success: false,
      message: 'Not authorized to update this order'
    });
  }

  // Check if order can be cancelled (only for customers)
  if (status === 'cancelled' && req.user.role !== 'admin') {
    if (!order.canBeCancelled()) {
      return res.status(400).json({
        success: false,
        message: 'Order cannot be cancelled at this stage'
      });
    }
  }

  await order.updateStatus(status, note, req.user.id);

  // Send status update email
  try {
    const { sendEmail } = require('../services/emailService');
    
    // Get customer info
    let customerEmail, customerName;
    if (order.user) {
      const user = await require('../models/User').findById(order.user);
      customerEmail = user.email;
      customerName = user.fullName;
    } else if (order.guestInfo) {
      customerEmail = order.guestInfo.email;
      customerName = order.guestInfo.fullName;
    }
    
    if (customerEmail) {
      const statusMessages = {
        'pending': 'Your order is being processed',
        'confirmed': 'Your order has been confirmed and is being prepared',
        'processing': 'Your order is being processed',
        'shipping': 'Your order is on its way',
        'delivered': 'Your order has been delivered',
        'cancelled': 'Your order has been cancelled',
        'returned': 'Your order has been returned'
      };
      
      const emailMessage = `
Dear ${customerName},

Your order status has been updated.

Order Details:
- Order Number: ${order.orderNumber}
- New Status: ${status}
- Message: ${statusMessages[status] || 'Status updated'}
${note ? `- Note: ${note}` : ''}

${status === 'shipping' ? 'Your order is on its way! You can track your order using the tracking number provided.' : ''}
${status === 'delivered' ? 'Your order has been successfully delivered. Thank you for your purchase!' : ''}
${status === 'cancelled' ? 'Your order has been cancelled. If you have any questions, please contact our support team.' : ''}

Thank you for choosing our store!

Best regards,
TechStore Team
      `;
      
      await sendEmail({
        email: customerEmail,
        subject: `Order Status Update - ${order.orderNumber}`,
        message: emailMessage
      });
      
      console.log('ğŸ“§ Order status update email sent to:', customerEmail);
    }
  } catch (error) {
    console.error('âŒ Failed to send status update email:', error);
    // Don't fail the status update if email fails
  }

  res.json({
    success: true,
    message: 'Order status updated successfully',
    data: { order }
  });
});

module.exports = {
  createOrder,
  getMyOrders,
  getOrders,
  getOrder,
  updateOrderStatus
};
